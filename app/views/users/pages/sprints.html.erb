<%= render(partial: 'layouts/page_header', locals: {
  icon: 'rocket',
  title: current_user.admin? ? 'Sprints' : 'Meus sprints',
  subtitle: pluralize(@sprints.size, 'sprint realizado', 'sprints realizados')
}); %>

<div class="container page-container">
  <table class="table is-bordered">
    <thead>
      <tr>
        <th>Equipe</th>
        <th>Nome</th>
        <th>Data inicio</th>
        <th>Data fim</th>
        <th>SP`s</th>
        <th>Goals</th>
        <th width="220"></th>
      </tr>
    </thead>

    <tbody>
      <% @sprints.each do |sprint| %>
        <% story_points = sprint.story_points %>
        <% promised_story_points = story_points.sum(&:expected_value) %>
        <% story_points_done = story_points.sum(&:value) %>
        <% goals = sprint.goals %>
        <% goals_count = goals.count %>
        <% completed = goals.where(completed: true).count %>
        <% if completed == goals_count %>
          <% class_name = 'succeded-sprint' %>
        <% elsif completed / goals_count.to_f >= 0.8 %>
          <% class_name = 'partially-succeded-sprint' %>
        <% elsif !sprint.closed? %>
          <% class_name = '' %>
        <% else %>
          <% class_name = 'failed-sprint' %>
        <% end %>
        <tr class='<%= class_name %>'>
          <td><%= sprint.squad.name %></td>
          <td><%= sprint.squad_counter %></td>
          <td><%= format_date(sprint.start_date) %></td>
          <td><%= format_date(sprint.due_date) %></td>
          <td><%= story_points_done %> / <%= promised_story_points %> (<%= promised_story_points.to_i > 0 ? (story_points_done / promised_story_points.to_f * 100).round(2) : 0 %>%)</td>
          <td><%= completed %> / <%= goals_count %> (<%= goals_count.to_i > 0 ? (completed / goals_count.to_f * 100).round(2) : 0 %>%)</td>
          <td>
            <div class="buttons has-addons is-centered">
              <%= link_to('Ver sprint', edit_sprint_path(sprint), 
                class: 'button is-small') %>
              <%= link_to('Gerenciar DMs', daily_meetings_sprint_path(sprint), 
                class: 'button is-small') %>
            </div>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>
